<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>eSmart Calc Nesting system</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
    body { font-family: 'Segoe UI', Arial, sans-serif; padding: 20px; background-color: #f0f2f5; color: #333; }
    .container { max-width: 1300px; margin: 0 auto; background: white; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border-radius: 12px; }
    
    h2 { color: #1a73e8; margin-top: 0; display: flex; align-items: center; justify-content: space-between; border-bottom: 2px solid #e8f0fe; padding-bottom: 10px; }
    h3 { color: #2c3e50; margin: 25px 0 10px 0; font-size: 1.2em; display: flex; align-items: center; gap: 8px; }
    .db-status { font-size: 12px; color: #34a853; font-weight: normal; }
    
    .config-bar { display: flex; gap: 20px; margin-bottom: 20px; background: #e8f0fe; padding: 15px; border-radius: 8px; flex-wrap: wrap; }
    .config-group { display: flex; flex-direction: column; gap: 5px; }
    .config-group label { font-size: 11px; font-weight: bold; text-transform: uppercase; color: #555; }
    input, select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 140px; }

    .import-area { background: #f8f9fa; border: 2px dashed #cbd5e0; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
    #excelPaste { width: 100%; height: 60px; border: 1px solid #ddd; border-radius: 4px; padding: 10px; font-family: monospace; font-size: 12px; }

    table { border-collapse: collapse; width: 100%; margin-top: 10px; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    th, td { border: 1px solid #eee; padding: 10px; text-align: center; }
    th { background: #1a73e8; color: white; font-size: 13px; }
    .weight-col { background: #f1f8ff; font-weight: bold; color: #1a73e8; }
    .stock-header { background: #2c3e50 !important; }
    
    .btn { cursor: pointer; padding: 10px 18px; border: none; border-radius: 6px; font-weight: 600; transition: 0.2s; }
    .btn-import { background: #34a853; color: white; margin-top: 10px; }
    .btn-add { background: #6c757d; color: white; font-size: 13px; margin-bottom: 10px; }
    .btn-calc { background: #1a73e8; color: white; font-size: 1.1em; width: 100%; padding: 15px; margin-top: 20px; }
    .btn-pdf { background: #ea4335; color: white; }
    .btn-clear { background: #95a5a6; color: white; }
    
    .btn-icon { padding: 6px 10px; font-size: 14px; border-radius: 4px; border:none; cursor: pointer; margin: 0 2px; }
    .btn-rem { background: #ff4d4d; color: white; }
    .btn-clone { background: #f1c40f; color: #333; }
    .btn-icon:hover { opacity: 0.8; transform: scale(1.05); }

    #results { margin-top: 40px; }
    .plate-card { background: white; border: 1px solid #ddd; padding: 15px; margin-bottom: 30px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
    canvas { display: block; max-width: 100%; height: auto; border: 2px solid #2c3e50; margin-top: 15px; background: #fff; }
    .summary-box { background: #e6fffa; border-left: 5px solid #38b2ac; padding: 20px; margin-bottom: 25px; border-radius: 4px; display: flex; justify-content: space-around; font-size: 1.2em; }
</style>
</head>
<body onload="initDB()">

<div class="container">
    <h2>
        <span>üîß eSmart Calc Nesting system</span>
        <span id="status" class="db-status">Checking Storage...</span>
    </h2>

    <div class="config-bar">
        <div class="config-group"><label>Material Type</label>
            <select id="materialType" onchange="updateWeights()">
                <option value="7.85">Mild Steel (7.85)</option>
                <option value="8.00">Stainless Steel (8.00)</option>
                <option value="2.70">Aluminum (2.70)</option>
            </select>
        </div>
        <div class="config-group"><label>Thickness (mm)</label><input type="number" id="thickness" value="5" onchange="updateWeights()"></div>
        <div class="config-group"><label>Kerf (Blade Width)</label><input type="number" id="bladeSize" value="2"></div>
    </div>

    <div class="section">
        <h3>üì¶ 1. Stock Plate Inventory</h3>
        <button class="btn btn-add" onclick="addStockRow()">+ Add Stock Plate</button>
        <table id="stockTable">
            <thead>
                <tr>
                    <th class="stock-header">Stock Width (mm)</th>
                    <th class="stock-header">Stock Length (mm)</th>
                    <th class="stock-header">Qty Available</th>
                    <th class="stock-header">Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="section">
        <h3>üß© 2. Parts to be Cut</h3>
        <div class="import-area">
            <label><strong>Excel Import (Paste Width | Length | Qty)</strong></label>
            <textarea id="excelPaste" placeholder="Example: 1250 [Tab] 400 [Tab] 42"></textarea>
            <button class="btn btn-import" onclick="importFromExcel()">üì• Import from Excel</button>
        </div>
        
        <button class="btn btn-add" style="background: #1a73e8;" onclick="addPartRow()">+ Add Single Part</button>
        
        <table id="inputTable">
            <thead>
                <tr>
                    <th>Width (mm)</th>
                    <th>Length (mm)</th>
                    <th>Qty</th>
                    <th style="background:#2c3e50;">Part Weight (kg)</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <button class="btn btn-calc" onclick="optimize()">‚öô CALCULATE NESTING & GENERATE MAPS</button>

    <div id="results"></div>

    <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: center;">
        <button class="btn btn-pdf" id="pdfBtn" onclick="downloadPDF()" style="display:none;">üìÑ Download PDF Report</button>
        <button class="btn btn-clear" onclick="clearData()">üßπ Clear All Data</button>
    </div>
</div>

<script>
let PLATES = [];
let db;

// --- DATABASE LOGIC ---
function initDB() {
    const request = indexedDB.open("NestingProDB_V3", 1);
    request.onupgradeneeded = (e) => {
        db = e.target.result;
        db.createObjectStore("settings", { keyPath: "id" });
    };
    request.onsuccess = (e) => {
        db = e.target.result;
        document.getElementById("status").innerText = "‚úî Storage Ready";
        loadSavedData();
    };
}

function saveData() {
    const transaction = db.transaction(["settings"], "readwrite");
    const store = transaction.objectStore("settings");
    
    let parts = [];
    document.querySelectorAll("#inputTable tbody tr").forEach(row => {
        const ins = row.querySelectorAll("input");
        if(ins[0]) parts.push({ w: ins[0].value, l: ins[1].value, q: ins[2].value });
    });

    let stocks = [];
    document.querySelectorAll("#stockTable tbody tr").forEach(row => {
        const ins = row.querySelectorAll("input");
        if(ins[0]) stocks.push({ w: ins[0].value, l: ins[1].value, q: ins[2].value });
    });

    store.put({
        id: "currentWork",
        material: document.getElementById("materialType").value,
        thickness: document.getElementById("thickness").value,
        bladeSize: document.getElementById("bladeSize").value,
        parts: parts,
        stocks: stocks
    });
    document.getElementById("status").innerText = "‚úî Auto-Saved";
}

function loadSavedData() {
    const transaction = db.transaction(["settings"], "readonly");
    const store = transaction.objectStore("settings");
    const request = store.get("currentWork");
    request.onsuccess = () => {
        if (request.result) {
            const d = request.result;
            document.getElementById("materialType").value = d.material;
            document.getElementById("thickness").value = d.thickness;
            document.getElementById("bladeSize").value = d.bladeSize;
            if(d.stocks) d.stocks.forEach(s => addStockRow(s.w, s.l, s.q));
            if(d.parts) d.parts.forEach(p => addPartRow(p.w, p.l, p.q));
            updateWeights();
        } else {
            addStockRow(2000, 6000, 10);
        }
    };
}

function clearData() {
    if(confirm("Clear everything?")) {
        const transaction = db.transaction(["settings"], "readwrite");
        transaction.objectStore("settings").clear();
        location.reload();
    }
}

// --- TABLE CONTROLS ---
function addStockRow(w='', l='', q='') {
    const tbody = document.querySelector("#stockTable tbody");
    const row = tbody.insertRow(-1);
    row.innerHTML = `<td><input type="number" value="${w}"></td>
                     <td><input type="number" value="${l}"></td>
                     <td><input type="number" value="${q}"></td>
                     <td><button class="btn-icon btn-rem" onclick="this.closest('tr').remove()">‚ùå</button></td>`;
}

function addPartRow(w='', l='', q='') {
    const tbody = document.querySelector("#inputTable tbody");
    const row = tbody.insertRow(-1);
    row.innerHTML = `<td><input type="number" value="${w}" oninput="updateWeights()"></td>
                     <td><input type="number" value="${l}" oninput="updateWeights()"></td>
                     <td><input type="number" value="${q}" oninput="updateWeights()"></td>
                     <td class="weight-col">0.00</td>
                     <td>
                        <button class="btn-icon btn-clone" onclick="clonePart(this)">üìã</button>
                        <button class="btn-icon btn-rem" onclick="this.closest('tr').remove(); updateWeights();">‚ùå</button>
                     </td>`;
    updateWeights();
}

function clonePart(btn) {
    const row = btn.closest('tr');
    const inputs = row.querySelectorAll('input');
    addPartRow(inputs[0].value, inputs[1].value, inputs[2].value);
}

function importFromExcel() {
    const rawData = document.getElementById("excelPaste").value.trim();
    if (!rawData) return;
    rawData.split(/\r?\n/).forEach(line => {
        const cols = line.split(/\t/);
        if (cols.length >= 2) addPartRow(cols[0], cols[1], cols[2] || 1);
    });
    document.getElementById("excelPaste").value = "";
}

function updateWeights() {
    const density = parseFloat(document.getElementById("materialType").value);
    const thick = parseFloat(document.getElementById("thickness").value);
    document.querySelectorAll("#inputTable tbody tr").forEach(row => {
        const ins = row.querySelectorAll("input");
        const w = parseFloat(ins[0].value) || 0, l = parseFloat(ins[1].value) || 0, q = parseInt(ins[2].value) || 0;
        row.cells[3].innerText = (w && l && q) ? ((w * l * thick * density * q) / 1000000).toFixed(2) : "0.00";
    });
}

// --- NESTING LOGIC ---
function optimize() {
    const kerf = parseFloat(document.getElementById("bladeSize").value);
    const thick = parseFloat(document.getElementById("thickness").value);
    const density = parseFloat(document.getElementById("materialType").value);
    
    let parts = [];
    let stockPool = [];
    let grossWeight = 0;

    // Collect Data
    document.querySelectorAll("#inputTable tbody tr").forEach(row => {
        const ins = row.querySelectorAll("input");
        const w = parseFloat(ins[0].value), l = parseFloat(ins[1].value), q = parseInt(ins[2].value);
        if (w && l && q) {
            grossWeight += ((w * l * thick * density * q) / 1000000);
            for(let i=0; i<q; i++) parts.push({ d1: w, d2: l });
        }
    });

    document.querySelectorAll("#stockTable tbody tr").forEach(row => {
        const ins = row.querySelectorAll("input");
        const w = parseFloat(ins[0].value), l = parseFloat(ins[1].value), q = parseInt(ins[2].value);
        if (w && l && q) {
            for(let i=0; i<q; i++) stockPool.push({ sw: w, sl: l });
        }
    });

    if (parts.length === 0 || stockPool.length === 0) return alert("Add Stock and Parts first!");
    saveData();

    // Sort parts by height (longest dimension)
    parts.sort((a,b) => Math.max(b.d1, b.d2) - Math.max(a.d1, a.d2));
    
    // Sort stock
    stockPool.sort((a,b) => (b.sw * b.sl) - (a.sw * a.sl));

    PLATES = [];
    let remainingParts = [...parts];

    // Main Nesting Loop
    for (let stock of stockPool) {
        if (remainingParts.length === 0) break;

        let plate = { sw: stock.sw, sl: stock.sl, shelves: [], items: [], usedArea: 0 };
        let index = 0;
        
        while (index < remainingParts.length) {
            let part = remainingParts[index];
            if (tryFitInPlate(plate, part, kerf)) {
                remainingParts.splice(index, 1); // Remove part from queue if it fits
            } else {
                index++; // Skip to next part
            }
        }
        
        if (plate.items.length > 0) PLATES.push(plate);
    }

    if (remainingParts.length > 0) alert(`${remainingParts.length} parts couldn't fit. You need more stock!`);

    render(grossWeight);
    document.getElementById("pdfBtn").style.display = "block";
}

function tryFitInPlate(plate, part, kerf) {
    const sw = plate.sw;
    const sl = plate.sl;
    
    const orient1 = { w: part.d1, l: part.d2 };
    const orient2 = { w: part.d2, l: part.d1 };
    const orients = [orient1, orient2];

    // 1. Try fitting into an existing shelf
    for (let shelf of plate.shelves) {
        for (let o of orients) {
            if (o.w <= shelf.freeW && o.l <= shelf.h) {
                plate.items.push({ x: sw - shelf.freeW, y: shelf.y, w: o.w, l: o.l });
                shelf.freeW -= (o.w + kerf);
                plate.usedArea += (o.w * o.l);
                return true;
            }
        }
    }

    // 2. Try creating a new shelf
    let currentY = plate.shelves.reduce((sum, s) => sum + s.h + kerf, 0);
    for (let o of orients) {
        if (o.l <= (sl - currentY) && o.w <= sw) {
            let newShelf = { y: currentY, h: o.l, freeW: sw - (o.w + kerf) };
            plate.shelves.push(newShelf);
            plate.items.push({ x: 0, y: currentY, w: o.w, l: o.l });
            plate.usedArea += (o.w * o.l);
            return true;
        }
    }

    return false;
}

// --- RENDERING ---
function render(grossW) {
    const res = document.getElementById("results");
    const totalUsed = PLATES.reduce((a,b) => a + b.usedArea, 0);
    const totalStock = PLATES.reduce((a,b) => a + (b.sw * b.sl), 0);
    
    res.innerHTML = `
        <div class="summary-box">
            <div><strong>Plates Used:</strong> ${PLATES.length}</div>
            <div><strong>Avg Efficiency:</strong> ${((totalUsed/totalStock)*100).toFixed(1)}%</div>
            <div style="color:#1a73e8;"><strong>Total Project Weight:</strong> ${grossW.toFixed(2)} kg</div>
        </div>
    `;
    
    PLATES.forEach((p, i) => {
        const div = document.createElement("div");
        div.className = "plate-card";
        div.innerHTML = `<strong>Map #${i+1} ‚Äî Sheet Size: ${p.sw}mm x ${p.sl}mm</strong>`;
        
        const canv = document.createElement("canvas");
        const scale = 1100 / Math.max(p.sw, p.sl);
        canv.width = p.sw * scale; canv.height = p.sl * scale;
        const ctx = canv.getContext("2d");
        
        ctx.fillStyle = "#fff"; ctx.fillRect(0,0,canv.width,canv.height);
        
        p.items.forEach(it => {
            ctx.fillStyle = "#4a90e2"; ctx.globalAlpha = 0.8;
            ctx.fillRect(it.x*scale, it.y*scale, it.w*scale, it.l*scale);
            ctx.strokeStyle = "#2c3e50"; ctx.globalAlpha = 1; ctx.lineWidth = 2;
            ctx.strokeRect(it.x*scale, it.y*scale, it.w*scale, it.l*scale);
            ctx.fillStyle = "#fff"; ctx.font = "bold 12px Arial";
            ctx.textAlign = "center";
            if(it.w * scale > 40) ctx.fillText(`${it.w}x${it.l}`, (it.x + it.w/2)*scale, (it.y + it.l/2)*scale + 5);
        });
        
        div.appendChild(canv);
        res.appendChild(div);
    });
}

// --- PDF FIX HERE ---
async function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    const canvases = document.querySelectorAll("canvas");
    
    // Get Thickness and Material Name for the filename
    const thickness = document.getElementById("thickness").value;
    const materialSelect = document.getElementById("materialType");
    const materialName = materialSelect.options[materialSelect.selectedIndex].text.split(' (')[0]; 
    
    const pageWidth = 190;
    const pageHeight = 270;

    for (let i = 0; i < canvases.length; i++) {
        if (i > 0) doc.addPage();

        const title = document.querySelectorAll(".plate-card strong")[i].innerText;
        doc.setFontSize(14);
        doc.text(title, 10, 15);

        const canvas = canvases[i];
        const imgData = canvas.toDataURL("image/png");
        
        const imgWidth = canvas.width;
        const imgHeight = canvas.height;
        const ratio = imgWidth / imgHeight;

        let finalW = pageWidth;
        let finalH = finalW / ratio;

        if (finalH > pageHeight) {
            finalH = pageHeight;
            finalW = finalH * ratio;
        }

        doc.addImage(imgData, 'PNG', 10, 25, finalW, finalH);
    }
    
    // Filename will look like: "Mild Steel_5mm_Cutting_Plan.pdf"
    doc.save(`${materialName}_${thickness}mm_Cutting_Plan.pdf`);
}

</script>

<script>
document.addEventListener("contextmenu", function(e) {
  e.preventDefault();
});
</script>
</body>
</html>