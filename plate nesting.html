<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Rotation Plate Nesting</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
    body { font-family: 'Segoe UI', Arial, sans-serif; padding: 20px; background-color: #f0f2f5; color: #333; }
    .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border-radius: 12px; }
    
    h2 { color: #1a73e8; margin-top: 0; display: flex; align-items: center; justify-content: space-between; }
    .db-status { font-size: 12px; color: #34a853; font-weight: normal; }
    
    .import-area { background: #f8f9fa; border: 2px dashed #cbd5e0; padding: 15px; border-radius: 8px; margin-bottom: 25px; }
    #excelPaste { width: 100%; height: 60px; border: 1px solid #ddd; border-radius: 4px; padding: 10px; font-family: monospace; }
    
    .config-bar { display: flex; gap: 20px; margin-bottom: 20px; background: #e8f0fe; padding: 15px; border-radius: 8px; flex-wrap: wrap; }
    .config-group { display: flex; flex-direction: column; gap: 5px; }
    .config-group label { font-size: 11px; font-weight: bold; text-transform: uppercase; color: #555; }
    input, select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 130px; }

    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #eee; padding: 10px; text-align: center; }
    th { background: #1a73e8; color: white; }
    .weight-col { background: #f1f8ff; font-weight: bold; }
    
    .btn { cursor: pointer; padding: 10px 18px; border: none; border-radius: 6px; font-weight: 600; transition: 0.2s; margin-top: 5px; }
    .btn-import { background: #34a853; color: white; }
    .btn-calc { background: #1a73e8; color: white; }
    .btn-pdf { background: #ea4335; color: white; }
    .btn-clear { background: #95a5a6; color: white; }
    .btn-rem { background: #ff4d4d; color: white; padding: 4px 8px; font-size: 11px; }
    .btn:hover { opacity: 0.8; transform: translateY(-1px); }

    #results { margin-top: 30px; }
    .plate-card { background: white; border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; border-radius: 8px; }
    canvas { display: block; max-width: 100%; height: auto; border: 1px solid #000; margin-top: 10px; background: #fff; }
    .summary-box { background: #e6fffa; border-left: 5px solid #38b2ac; padding: 15px; margin-bottom: 20px; border-radius: 4px; display: flex; justify-content: space-around; font-size: 1.1em; }

            .top-nav {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
        }
</style>
</head>
<body onload="initDB()">
<nav class="top-nav">
    <a href="nesting.html" class="home-link"><span>üè†</span> Back</a>
</nav>
<div class="container">
    <h2>
        <span>üìã eSmart Calc Plate Nesting & Weight</span>
        <span id="status" class="db-status">Loading...</span>
    </h2>

    <div class="import-area">
        <label><strong>Paste from Excel (Width | Length | Qty)</strong></label>
        <textarea id="excelPaste" placeholder="Example:&#10;1250	400	42"></textarea>
        <button class="btn btn-import" onclick="importFromExcel()">üì• Import Data</button>
    </div>

    <div class="config-bar">
        <div class="config-group"><label>Material</label>
            <select id="materialType" onchange="updateWeights()">
                <option value="7.85">Mild Steel (7.85)</option>
                <option value="8.00">Stainless Steel (8.00)</option>
                <option value="2.70">Aluminum (2.70)</option>
            </select>
        </div>
        <div class="config-group"><label>Thickness (mm)</label><input type="number" id="thickness" value="5" onchange="updateWeights()"></div>
        <div class="config-group"><label>Stock Width</label><input type="number" id="stockWidth" value="1220"></div>
        <div class="config-group"><label>Stock Length</label><input type="number" id="stockLength" value="2440"></div>
        <div class="config-group"><label>Kerf (Blade)</label><input type="number" id="bladeSize" value="0"></div>
    </div>

    <table id="inputTable">
        <thead>
            <tr>
                <th>Width (mm)</th>
                <th>Length (mm)</th>
                <th>Qty</th>
                <th style="background:#2c3e50;">Weight (kg)</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div style="margin-top: 20px; display: flex; gap: 10px;">
        <button class="btn btn-calc" onclick="optimize()">‚öô Calculate Smart Nesting</button>
        <button class="btn btn-pdf" id="pdfBtn" onclick="downloadPDF()" style="display:none;">üìÑ Download PDF Report</button>
        <button class="btn btn-clear" onclick="clearData()">üßπ Clear All</button>
    </div>

    <div id="results"></div>
</div>

<script>
let PLATES = [];
let db;

// --- DATABASE & SETUP ---
function initDB() {
    const request = indexedDB.open("SmartNestingDB", 1);
    request.onupgradeneeded = (e) => {
        db = e.target.result;
        db.createObjectStore("settings", { keyPath: "id" });
    };
    request.onsuccess = (e) => {
        db = e.target.result;
        document.getElementById("status").innerText = "‚úî Ready";
        loadSavedData();
    };
}

function saveData(parts) {
    const transaction = db.transaction(["settings"], "readwrite");
    const store = transaction.objectStore("settings");
    store.put({
        id: "currentWork",
        material: document.getElementById("materialType").value,
        thickness: document.getElementById("thickness").value,
        stockWidth: document.getElementById("stockWidth").value,
        stockLength: document.getElementById("stockLength").value,
        bladeSize: document.getElementById("bladeSize").value,
        parts: parts
    });
    document.getElementById("status").innerText = "‚úî Auto-Saved";
}

function loadSavedData() {
    const transaction = db.transaction(["settings"], "readonly");
    const store = transaction.objectStore("settings");
    const request = store.get("currentWork");
    request.onsuccess = () => {
        if (request.result) {
            const d = request.result;
            document.getElementById("materialType").value = d.material;
            document.getElementById("thickness").value = d.thickness;
            document.getElementById("stockWidth").value = d.stockWidth;
            document.getElementById("stockLength").value = d.stockLength;
            document.getElementById("bladeSize").value = d.bladeSize;
            d.parts.forEach(p => addRow(p.w, p.l, p.q));
            updateWeights();
        }
    };
}

function clearData() {
    if(confirm("Clear all data?")) {
        const transaction = db.transaction(["settings"], "readwrite");
        transaction.objectStore("settings").clear();
        location.reload();
    }
}

// --- TABLE & CALCS ---
function calculatePartWeight(w, l, t, density) {
    return ((w * l * t * density) / 1000000).toFixed(2);
}

function updateWeights() {
    const density = parseFloat(document.getElementById("materialType").value);
    const thick = parseFloat(document.getElementById("thickness").value);
    document.querySelectorAll("#inputTable tbody tr").forEach(row => {
        const ins = row.querySelectorAll("input");
        const w = parseFloat(ins[0].value) || 0;
        const l = parseFloat(ins[1].value) || 0;
        const q = parseInt(ins[2].value) || 0;
        row.cells[3].innerText = (w && l && q) ? (calculatePartWeight(w, l, thick, density) * q).toFixed(2) : "0.00";
    });
}

function addRow(w='', l='', q='') {
    const tableBody = document.querySelector("#inputTable tbody");
    const row = tableBody.insertRow(-1);
    row.innerHTML = `<td><input type="number" value="${w}" oninput="updateWeights()"></td>
                     <td><input type="number" value="${l}" oninput="updateWeights()"></td>
                     <td><input type="number" value="${q}" oninput="updateWeights()"></td>
                     <td class="weight-col">0.00</td>
                     <td><button class="btn btn-rem" onclick="this.closest('tr').remove(); updateWeights();">‚ùå</button></td>`;
    updateWeights();
}

function importFromExcel() {
    const rawData = document.getElementById("excelPaste").value.trim();
    if (!rawData) return;
    rawData.split(/\r?\n/).forEach(line => {
        const cols = line.split(/\t/);
        if (cols.length >= 2) addRow(cols[0], cols[1], cols[2] || 1);
    });
    document.getElementById("excelPaste").value = "";
}

// --- SMART NESTING ENGINE ---
function optimize() {
    const sw = parseFloat(document.getElementById("stockWidth").value);
    const sl = parseFloat(document.getElementById("stockLength").value);
    const kerf = parseFloat(document.getElementById("bladeSize").value);
    const thick = parseFloat(document.getElementById("thickness").value);
    const density = parseFloat(document.getElementById("materialType").value);
    
    let partsToSave = [];
    let itemsToProcess = [];
    let grossWeight = 0;

    // 1. Read Inputs
    document.querySelectorAll("#inputTable tbody tr").forEach(row => {
        const ins = row.querySelectorAll("input");
        const w = parseFloat(ins[0].value), l = parseFloat(ins[1].value), q = parseInt(ins[2].value);
        if (w && l && q) {
            partsToSave.push({w, l, q});
            grossWeight += (calculatePartWeight(w, l, thick, density) * q);
            for(let i=0; i<q; i++) {
                // Store raw dimensions, do NOT pre-sort W/L. Let algorithm decide.
                itemsToProcess.push({ d1: w, d2: l });
            }
        }
    });

    if (itemsToProcess.length === 0) return alert("Add parts first!");
    saveData(partsToSave);

    // 2. Sort by Maximum Dimension (Tallest/Widest first)
    itemsToProcess.sort((a,b) => Math.max(b.d1, b.d2) - Math.max(a.d1, a.d2));

    PLATES = [];

    // 3. Place items
    itemsToProcess.forEach(part => {
        let placed = false;
        
        // Try fitting in existing plates
        for (let plate of PLATES) {
            if (tryFitInPlate(plate, part, sw, sl, kerf)) {
                placed = true;
                break;
            }
        }
        
        // If not, create new plate
        if (!placed) {
            let newPlate = { sw, sl, shelves: [], items: [], usedArea: 0 };
            if (tryFitInPlate(newPlate, part, sw, sl, kerf)) {
                PLATES.push(newPlate);
            } else {
                alert(`Part ${part.d1}x${part.d2} is too big for stock ${sw}x${sl}`);
            }
        }
    });

    render(sw, sl, grossWeight);
    document.getElementById("pdfBtn").style.display = "block";
}

// Tries to fit a part into a plate (checking BOTH rotations)
function tryFitInPlate(plate, part, sw, sl, kerf) {
    // A. Check existing shelves
    // We try both orientations: d1xd2 AND d2xd1
    // We prefer the orientation that "fits" the shelf height best (minimizes vertical waste)
    
    let bestFit = null;
    let minWaste = Infinity;

    // Orientation 1: w=d1, l=d2
    let o1 = { w: part.d1, l: part.d2 };
    // Orientation 2: w=d2, l=d1
    let o2 = { w: part.d2, l: part.d1 };
    
    let attempts = [o1, o2];

    for(let shelf of plate.shelves) {
        for(let orient of attempts) {
            // Must fit in shelf height & width
            if (orient.l <= shelf.h && orient.w <= shelf.freeW) {
                // It fits! How much vertical waste?
                let waste = shelf.h - orient.l;
                
                // We want to minimize waste, but if it fits perfectly, take it immediately
                if (waste < minWaste) {
                    minWaste = waste;
                    bestFit = { shelf: shelf, orient: orient };
                }
            }
        }
    }

    if (bestFit) {
        addToShelf(plate, bestFit.shelf, bestFit.orient, sw, kerf);
        return true;
    }

    // B. Create New Shelf
    // Calculate remaining vertical space on plate
    let usedY = plate.shelves.reduce((acc, s) => acc + s.h + kerf, 0);
    let remY = sl - usedY;

    // Check which orientations fit in the remaining New Shelf space
    let fits1 = (o1.l <= remY && o1.w <= sw);
    let fits2 = (o2.l <= remY && o2.w <= sw);

    if (!fits1 && !fits2) return false; // No room at all

    let chosenOrient = null;

    // DECISION LOGIC:
    // If both fit, pick the "Tallest" one to maintain packing density (Columns strategy).
    // Unless one is significantly wider and fills the row better? 
    // Standard Shelf Packing = Best Fit Height.
    if (fits1 && fits2) {
        if (o1.l >= o2.l) chosenOrient = o1;
        else chosenOrient = o2;
    } 
    // If only one fits (e.g., rotated at the bottom gap), MUST pick that one.
    else if (fits1) chosenOrient = o1;
    else chosenOrient = o2;

    // Create the shelf
    let newShelf = { y: usedY, h: chosenOrient.l, freeW: sw };
    plate.shelves.push(newShelf);
    addToShelf(plate, newShelf, chosenOrient, sw, kerf);
    return true;
}

function addToShelf(plate, shelf, orient, sw, kerf) {
    plate.items.push({ 
        x: sw - shelf.freeW, 
        y: shelf.y, 
        w: orient.w, 
        l: orient.l 
    });
    shelf.freeW -= (orient.w + kerf);
    plate.usedArea += (orient.w * orient.l);
}

// --- RENDER ---
function render(sw, sl, grossW) {
    const res = document.getElementById("results");
    const eff = ((PLATES.reduce((a,b)=>a+b.usedArea,0)/(PLATES.length*sw*sl))*100).toFixed(1);
    
    res.innerHTML = `
        <div class="summary-box">
            <div><strong>Total Plates:</strong> ${PLATES.length}</div>
            <div><strong>Efficiency:</strong> ${eff}%</div>
            <div style="color:#1a73e8;"><strong>Gross Weight:</strong> ${grossW.toFixed(2)} kg</div>
        </div>
    `;
    
    PLATES.forEach((p, i) => {
        const div = document.createElement("div");
        div.className = "plate-card";
        div.innerHTML = `<strong>Plate #${i+1}</strong>`;
        const canv = document.createElement("canvas");
        const scale = 800 / sw;
        canv.width = sw * scale; canv.height = sl * scale;
        const ctx = canv.getContext("2d");
        
        // Background
        ctx.fillStyle = "#fff"; ctx.fillRect(0,0,canv.width,canv.height);
        
        p.items.forEach(it => {
            // Draw Part
            ctx.fillStyle = "#4a90e2"; ctx.globalAlpha = 0.8;
            ctx.fillRect(it.x*scale, it.y*scale, it.w*scale, it.l*scale);
            
            // Border
            ctx.strokeStyle = "#2c3e50"; ctx.globalAlpha = 1; ctx.lineWidth = 1;
            ctx.strokeRect(it.x*scale, it.y*scale, it.w*scale, it.l*scale);
            
            // Text (Centered)
            ctx.fillStyle = "#fff"; ctx.font = "bold 11px Arial";
            ctx.textAlign = "center"; ctx.textBaseline = "middle";
            if(it.w * scale > 35 && it.l * scale > 15) {
                // Show dimensions relative to how it is placed
                ctx.fillText(`${it.w}x${it.l}`, (it.x + it.w/2)*scale, (it.y + it.l/2)*scale);
            }
        });
        div.appendChild(canv);
        res.appendChild(div);
    });
}

async function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    const canvases = document.querySelectorAll("canvas");
    const material = document.getElementById("materialType").options[document.getElementById("materialType").selectedIndex].text;
    const thickness = document.getElementById("thickness").value;
    const gross = document.querySelector(".summary-box").innerText.split("Gross Weight:")[1];

    for (let i = 0; i < canvases.length; i++) {
        if (i > 0) doc.addPage();
        doc.setFontSize(16); doc.text(`Plate Cutting Plan #${i + 1}`, 10, 15);
        doc.setFontSize(10); 
        doc.text(`Material: ${material} | Thickness: ${thickness}mm`, 10, 22);
        doc.text(`Stock: ${document.getElementById("stockWidth").value} x ${document.getElementById("stockLength").value} | Gross Wt: ${gross}`, 10, 27);
        const imgData = canvases[i].toDataURL("image/png");
        doc.addImage(imgData, 'PNG', 10, 35, 180, (canvases[i].height * 180) / canvases[i].width);
    }
    doc.save(`Procurement_Report.pdf`);
}
</script>
</body>
</html>